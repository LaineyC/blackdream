<div ng-controller="dataModelManageController">
    <div class="row" style="position: relative;">
        <div class="col-sm-2" style="width: 20%;position: fixed;top: 65px; bottom: 0;overflow: auto;">
            <div class="row">
                <div class="col-sm-12">
                    <button type="button" class="btn btn-primary btn-sm" location-back>返回</button>
                    <div class="btn-group  pull-right" role="group" aria-label="...">
                        <button type="button" ng-click="openConsoleModal();" class="btn btn-sm btn-info">
                            <span class="glyphicon glyphicon-console" aria-hidden="true">控制台</span>
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                生成<span class="caret"></span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-right">
                                <li ng-repeat="templateStrategy in templateStrategys"><a href="javascript:void(0);" ng-click="run(templateStrategy);">{{templateStrategy.name}}</a></li>
                                <li role="separator" class="divider"></li>
                                <li><a href="javascript:void(0);"  ng-click="dataDictionary();">数据字典</a></li>
                            </ul>
                        </div>
                        <button type="button" ng-click="dataModelControl.saveDirty();" ng-disabled="!dataModelControl.dirtyData.hasDirtyData();" class="btn btn-sm btn-warning">
                            <span class="glyphicon glyphicon-save" aria-hidden="true">保存</span>
                        </button>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-success dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="glyphicon glyphicon-plus" aria-hidden="true">新建</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-right">
                                <li ng-repeat="dynamicModel in dynamicModels | filter:{isRootChild:true}">
                                    <a href="javascript:void(0);" ng-click="dataModelControl.add(dynamicModel);"><span class="glyphicon glyphicon-{{dynamicModel.icon}}" ></span> {{dynamicModel.name}}</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12 condensed-list" style="width: 20%;position: fixed;top: 100px; bottom: 0;overflow: auto;">
                    <ul ui-sortable="dataModelControl.sortableOptions" ng-model="dataModel.children" style="padding-left: 0;" ng-init="parent=dataModel;" ng-include="'dataModelRecursion'" class="list-group" ng-show="dataModel.children.length"></ul>
                </div>
            </div>
        </div>
        <div class="col-sm-10" style="width: 80%;margin-left: 20%;">
                <uib-tabset ng-if="tabsControl.data.length">
                    <uib-tab ng-repeat="dataModel in tabsControl.data" active="dataModel.active" ng-init="tabsControl.initScope(dataModel,this)">
                        <uib-tab-heading><i class="text-info glyphicon glyphicon-{{dataModel.dynamicModel.icon}}"></i> <label>{{dataModel.name}}</label></uib-tab-heading>
                        <br/>
                        <form name="dataModelEditForm" class="form-horizontal" role="form" novalidate>
                            <div class="form-group">
                                <label class="col-sm-1 control-label"><span class="text-danger">名称</span></label>
                                <div class="col-sm-5">
                                    <input name="name" uib-tooltip="{{getMessage('name',dataModelEditForm.name.$error,validateMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.name.$invalid && dataModelEditForm.name.$dirty"
                                           ng-model="dataModel.name" type="text" class="form-control input-sm" placeholder="名称" ng-maxlength="50" required/>
                                </div>
                            </div>
                            <div class="form-group">
                                <label style="height:40px;" ng-repeat-start="property in dataModel.dynamicModel.properties" class="col-sm-1 control-label"><span ng-class="{'text-danger': property.validator.required}">{{property.label}}</span></label>
                                <div style="height:40px;" ng-repeat-end class="col-sm-{{property.viewWidth}}" ng-switch="property.type">
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                        tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                        ng-switch-when="Boolean" ng-model="dataModel.properties[property.name]" type="checkbox" ng-true-value="true" ng-false-value="false" ng-change="property.cascadeFunction(dataModel.properties)"/>
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                           ng-switch-when="Long" ng-model="dataModel.properties[property.name]" type="number" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)"
                                           min="{{property.validator.min}}" max="{{property.validator.max}}" ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                           ng-switch-when="Double" ng-model="dataModel.properties[property.name]" type="number" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)"
                                           min="{{property.validator.min}}" max="{{property.validator.max}}" ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                           ng-switch-when="String" ng-model="dataModel.properties[property.name]" type="text" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)"
                                           ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                           ng-switch-when="Date" ng-model="dataModel.properties[property.name]" type="text" readonly="readonly" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)"
                                           uib-datepicker-popup="yyyy-MM-dd" is-open="opened" ng-click="opened = !opened" close-text="关闭" current-text="今天"  clear-text="清除"
                                           ng-required="property.validator.required"/>
                                    <select name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                            tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                            ng-switch-when="Enum" ng-model="dataModel.properties[property.name]" ng-options="option for option in property.optionalValues" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)"
                                            ng-required="property.validator.required">
                                        <option value="">--选择--</option>
                                    </select>
                                    <input name="$properties${{property.name}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$properties$' + property.name].$error,validateMessageCache[dataModel.dynamicModel.id].propertiesMessages)}}"
                                           tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$properties${{property.name}}.$invalid && dataModelEditForm.$properties${{property.name}}.$dirty"
                                           ng-switch-when="Model" ng-model="dataModel.properties[property.name].name" readonly="readonly" type="text" class="form-control input-sm" ng-change="property.cascadeFunction(dataModel.properties)" ng-click="dataModelPickerModalOpen(dataModel,dataModel.properties,property.name,property.label,dataModelEditForm['$properties$' + property.name]);"
                                           ng-required="property.validator.required"/>
                                </div>
                            </div>
                            <div class="form-group" ng-if="dataModel.dynamicModel.association.length">
                                <div class="col-sm-12">
                                    <table class="table table-bordered table-condensed table-hover">
                                        <caption>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-success btn-sm" ng-click="tabsControl.addProperty(dataModel);">添加属性</button>
                                                <button type="button" class="btn btn-success btn-sm" ng-disabled="!dataModel.dynamicModel.predefinedAssociation.length" ng-click="tabsControl.addPredefinedProperty(dataModel);">预设属性</button>
                                            </div>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-sm" ng-class="{'btn-default':!dataModel.$copy,'btn-warning':dataModel.$copy}" ng-click="tabsControl.copyProperty(dataModel);">复制属性</button>
                                                <button type="button" class="btn btn-default btn-sm" ng-disabled="!tabsControl.hasClipboard(dataModel);" ng-click="tabsControl.pasteProperty(dataModel);">粘贴属性</button>
                                            </div>
                                        </caption>
                                        <thead>
                                        <tr class="active">
                                            <th width="25">#</th>
                                            <th width="{{property.viewWidth}}" ng-repeat="property in dataModel.dynamicModel.association">
                                                <span ng-class="{'text-danger': property.validator.required}">{{property.label}}</span>
                                            </th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody ui-sortable="sortableOptions" ng-model="dataModel.association">
                                        <tr ng-repeat="propertyValue in dataModel.association" ng-class="{'warning':propertyValue.$copy}">
                                            <td ng-click="dataModel.$copy && (propertyValue.$copy = !propertyValue.$copy)">{{$index + 1}}</td>
                                            <td align="center" ng-repeat="property in dataModel.dynamicModel.association" ng-switch="property.type" ng-init="propertyValue.__hashKey = hashKey(propertyValue)">
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="Boolean" ng-model="propertyValue[property.name]" type="checkbox" ng-true-value="true" ng-false-value="false" ng-change="property.cascadeFunction(propertyValue)"/>
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="Long" ng-model="propertyValue[property.name]" type="number" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)"
                                                       min="{{property.validator.min}}" max="{{property.validator.max}}" ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="Double" ng-model="propertyValue[property.name]" type="number" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)"
                                                       min="{{property.validator.min}}" max="{{property.validator.max}}" ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="String" ng-model="propertyValue[property.name]" type="text" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)"
                                                       ng-minlength="property.validator.minlength" ng-maxlength="property.validator.maxlength" ng-pattern="property.validator.pattern" ng-required="property.validator.required"/>
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="Date" ng-model="propertyValue[property.name]" type="text" readonly="readonly" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)"
                                                       uib-datepicker-popup="yyyy-MM-dd" is-open="opened" ng-click="opened = !opened" close-text="关闭" current-text="今天"  clear-text="清除"
                                                       ng-required="property.validator.required"/>
                                                <select name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                        tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                        ng-switch-when="Enum" ng-model="propertyValue[property.name]" ng-options="option for option in property.optionalValues" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)"
                                                        ng-required="property.validator.required">
                                                    <option value="">--选择--</option>
                                                </select>
                                                <input name="$association${{property.name + propertyValue.__hashKey}}" uib-tooltip="{{getMessage(property.name,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey].$error,validateMessageCache[dataModel.dynamicModel.id].associationMessages)}}"
                                                       tooltip-trigger="none" tooltip-is-open="dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$invalid && dataModelEditForm.$association${{property.name + propertyValue.__hashKey}}.$dirty"
                                                       ng-switch-when="Model" ng-model="propertyValue[property.name].name" readonly="readonly" type="text" class="form-control input-sm" ng-change="property.cascadeFunction(propertyValue)" ng-click="dataModelPickerModalOpen(dataModel,propertyValue,property.name,property.label,dataModelEditForm['$association$' + property.name + propertyValue.__hashKey]);"
                                                       ng-required="property.validator.required"/>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <button type="button" class="btn btn-danger btn-sm" ng-click="tabsControl.removeProperty(dataModel, $index)">删除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </form>
                    </uib-tab>
                </uib-tabset>
        </div>
    </div>
</div>
<!-- 控制台对话框 -->
<script id="dataModel/console.html" type="text/ng-template" >
    <div class="modal-header">
        <h3 class="modal-title">控制台 {{runningText}}</h3>
    </div>
    <div class="modal-body">
        <ul class="list-group" ng-repeat="result in runResults track by $index" ng-switch="result.type">
            <li class="list-group-item" ng-switch-when="url"><a ng-click="download(result.url)" href="javascript:void(0)"><i class="glyphicon glyphicon-cloud-download"></i> 点击下载 <span class="text-info">{{result.fileName}}</span></a></li>
            <li class="list-group-item list-group-item-danger" ng-switch-when="error">
                <i class="glyphicon glyphicon-plus" ng-class="result.$closed ?'glyphicon-plus' : 'glyphicon-minus'" ng-click="result.$closed = !result.$closed;"></i>
                <label>异常信息</label>
                <ul class="list-group" ng-repeat="message in result.messages track by $index" ng-show="!result.$closed">
                    <li class="list-group-item">{{message}}</li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="modal-footer">
        <button class="btn btn-sm btn-warning" type="button" ng-click="clear()">清除</button>
        <button class="btn btn-sm btn-primary" type="button" ng-click="confirm()">关闭</button>
    </div>
</script>
<script id="dataModelRecursion" type="text/ng-template">
    <li class="list-group-item" ng-repeat="child in parent.children" ng-init="p=parent;">
        <i class="glyphicon glyphicon-plus" ng-class="child.children.length ? (child.$expend ? 'glyphicon-minus' : 'glyphicon-plus') : 'glyphicon-leaf'" ng-click="child.$expend =! child.$expend;"></i>
        {{$index + 1}}
        <span class="text-info glyphicon glyphicon-{{child.dynamicModel.icon}}"></span>
        <label ng-dblclick="dataModelControl.view(child);">{{child.name}}</label>
        <div class="btn-group pull-right">
            <button ng-if="!child.children.length" type="button" class="btn btn-danger btn-xs" ng-click="dataModelControl.delete(p, $index, child);">
                <span class="glyphicon glyphicon-remove"></span>
            </button>
            <button ng-if="child.dynamicModel.children.length" type="button" class="btn btn-success dropdown-toggle btn-xs" data-toggle="dropdown">
                <span class="glyphicon glyphicon-plus"></span>
            </button>
            <ul ng-if="child.dynamicModel.children.length" class="dropdown-menu dropdown-menu-right" role="menu">
                <li ng-repeat="dynamicModel in child.dynamicModel.children">
                    <a href="javascript:void(0);" ng-click="dataModelControl.add(dynamicModel, child);">
                        <span class="glyphicon glyphicon-{{dynamicModel.icon}}"></span> {{dynamicModel.name}}
                    </a>
                </li>
            </ul>
        </div>
        <ul ui-sortable="dataModelControl.sortableOptions" ng-model="child.children" class="list-group" ng-include="'dataModelRecursion'" ng-show="child.$expend && child.children.length" ng-init="parent=child;"></ul>
    </li>
</script>
<!-- 关联模型对话框 -->
<script id="dataModel/dataModelPicker.html" type="text/ng-template" >
    <div class="modal-header">
        <h3 class="modal-title">{{title}}</h3>
    </div>
    <div class="modal-body condensed-list">
        <div style="padding-left: 0px;" ng-init="parent=dataModel;" ng-include="'dataModelPickerRecursion'" class="list-group" ng-show="dataModel.children.length"></div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-sm btn-danger" type="button" ng-click="clear()">清除</button>
        <button class="btn btn-sm btn-primary" type="button" ng-click="confirm()">关闭</button>
    </div>
</script>
<script id="dataModelPickerRecursion" type="text/ng-template">
    <a href="javascript:void(0)" class="list-group-item" ng-repeat="child in parent.children" ng-init="p=parent;">
        <i class="glyphicon glyphicon-plus" ng-class="child.children.length ? (child.$$expend ? 'glyphicon-minus' : 'glyphicon-plus') : 'glyphicon-ban-circle'" ng-click="child.$$expend =! child.$$expend;"></i>
        {{$index + 1}}
        <span class="glyphicon glyphicon-{{child.dynamicModel.icon}}"></span>
        <label ng-dblclick="select(child);">{{child.name}}</label>
        <div class="list-group" ng-include="'dataModelPickerRecursion'" ng-show="child.$$expend && child.children.length" ng-init="parent=child;"></div>
    </a>
</script>
